<script>
  import cardData from '$gameFiles/card-data.json';
  import { GameData } from '$gameData';
  import Card from '$components/Card.svelte';
  import Modal from '$lib/components/Modal.svelte';
  import { CARD_CATEGORY_COLOR_MAP } from '$types';

  /** @type {import('$types').Card} */
  $: card = cardData[$GameData.currentCardId];

  /** Where or not to show the card's options */
  let showOptions = false;

  /** @type {import('$types').Option | null} */
  let displayedOption = null;

  const makeDecision = (optionId) => {
    // TODO: Handle invalid decision
    GameData.advanceGameState({ optionId });
  };

  /**
   * Gets the text for how income is adjusted based on the salary update.
   *
   * @param {number | undefined} salaryUpdate
   * @return {string}
   */
  const getIncomeAdjustmentText = (salaryUpdate) => {
    if (!salaryUpdate) {
      return "won't get any money";
    }

    let updateText = 'get';
    if (salaryUpdate < 0) {
      salaryUpdate = -salaryUpdate;
      updateText = 'stop earning';
    }

    return `will ${updateText} <b>$${salaryUpdate}</b>`;
  };

  /**
   * Gets the text for how hours are adjusted based on the option update.
   *
   * @param {number | undefined} hoursUpdate
   * @return {string}
   */
  const getHoursAdjustmentText = (hoursUpdate) => {
    if (!hoursUpdate) {
      return "won't have to work any additional hours";
    }

    if (hoursUpdate < 0) {
      return `will work <b>${-hoursUpdate}</b> fewer hours`;
    }

    return `will have to work <b>${hoursUpdate}</b> additional hours`;
  };

  /**
   * Creates an autogenerated description that describes the options' updates.
   *
   * @param {import('$types').Option} option
   * @returns {string}
   */
  const stringifyOption = (option) => {
    if (!option) {
      return '';
    }

    const updates = option.updates;
    const incomeAdjustmentText = getIncomeAdjustmentText(updates.income?.salary);
    const hoursAdjustmentText = getHoursAdjustmentText(updates.time);

    let finalText = `If you choose this option you ${incomeAdjustmentText} and ${hoursAdjustmentText}`;
    if (option.except) {
      finalText += `, ${option.except}`;
    }

    return finalText + '.';
  };

  $: optionUpdatesDescription = stringifyOption(displayedOption);
  $: backgroundColor = showOptions
    ? `var(--light-${CARD_CATEGORY_COLOR_MAP[card.category]})`
    : 'transparent';
</script>

<Modal showModal={displayedOption}>
  <div class="implication-body" slot="body">
    <h3>{displayedOption?.description}</h3>
    <p>{@html optionUpdatesDescription}</p>
    <p>{@html displayedOption?.implicationText || ''}</p>
    <button on:click={() => makeDecision(displayedOption.id)} class="button">Select</button>
  </div>
</Modal>
<main style:background-color={backgroundColor}>
  <Card {card} minimized={showOptions} onCardTap={() => (showOptions = !showOptions)} />
  {#if showOptions}
    <h3 class="prompt">{card.prompt || ''}</h3>
    <ul>
      {#each card.options as option (option.id)}
        <li>
          <button class="button button3" on:click={() => (displayedOption = option)}>
            {option.description}
          </button>
        </li>
      {/each}
    </ul>
  {/if}
</main>

<style>
  main {
    width: 100vw;
    height: 110vh;
    margin-top: -5vh;

    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    transition: background-color 200ms ease;
  }
  .implication-body {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .prompt {
    text-align: center;
  }

  ul {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
